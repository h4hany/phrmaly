import{a as Z}from"./chunk-FMYBUIAP.js";import{a as X}from"./chunk-6TIB4JPT.js";import{a as U}from"./chunk-QSZBM4NB.js";import{a as K,b as Q}from"./chunk-4PK2EB7K.js";import{a as Y}from"./chunk-CPH2TRFL.js";import{a as J}from"./chunk-PUVF5ECJ.js";import"./chunk-Y5QUESDN.js";import{d as s,e as T,f as V,h as G,k as B,l as j,m as $,n as R,t as H,v as z,w as L,x as W}from"./chunk-VW37JDOU.js";import{b as w,d as M}from"./chunk-QHH3SHC3.js";import"./chunk-KPWAPXFF.js";import"./chunk-ACQN7LQS.js";import{b as O}from"./chunk-7DC7YEPQ.js";import{$ as C,$a as a,$b as q,Bb as h,Cb as g,Ga as A,La as F,Ra as n,S as c,Sa as D,Wa as _,Xa as E,Y as S,Z as I,Za as k,_ as f,_a as N,ab as o,bb as p,db as P,eb as v,fb as x,nb as u,ob as y,pb as b,xa as i}from"./chunk-OKFD3A6M.js";import"./chunk-KAT7YFEL.js";function te(l,e){if(l&1){let r=P();a(0,"div",14)(1,"div",28),p(2,"app-autocomplete-input",29),o(),a(3,"div"),p(4,"app-text-input",30),o(),a(5,"div"),p(6,"app-text-input",31),o(),a(7,"div",32)(8,"button",33),v("click",function(){let d=S(r).$index,m=x();return I(m.removeItem(d))}),f(),a(9,"svg",34),p(10,"path",35),o()()()()}if(l&2){let r=e.$index,t=x();n("formGroupName",r),i(2),n("label","form.purchase.drug")("options",t.drugOptions)("placeholder","form.selectDrug"),i(2),n("label","form.purchase.quantity")("min",1),i(2),n("label","form.purchase.unitCost")("step",.01)("min",0)}}function re(l,e){l&1&&(f(),a(0,"svg",27),p(1,"circle",36)(2,"path",37),o())}function ie(l,e){l&1&&(f(),a(0,"svg",11),p(1,"path",38),o())}var ee=class l{fb=c(z);router=c(M);route=c(w);purchasesService=c(X);suppliersService=c(Z);drugsService=c(U);purchaseForm;loading=!1;errorMessage="";isEdit=!1;purchaseId=null;suppliers=[];pharmacyDrugs=[];supplierOptions=[];drugOptions=[];paymentStatusOptions=[{value:"pending",label:"payment.pending"},{value:"partial",label:"payment.partial"},{value:"paid",label:"payment.paid"}];get itemsArray(){return this.purchaseForm.get("items")}get totalAmount(){return this.itemsArray.value.reduce((r,t)=>r+(t.quantity*t.unitCost||0),0)}get remainingAmount(){let e=this.purchaseForm.get("paidAmount")?.value||0;return Math.max(0,this.totalAmount-e)}get formattedTotalAmount(){return this.totalAmount.toFixed(2)}get formattedRemainingAmount(){return this.remainingAmount.toFixed(2)}ngOnInit(){this.purchaseId=this.route.snapshot.paramMap.get("id"),this.isEdit=!!this.purchaseId,this.purchaseForm=this.fb.group({invoiceNumber:["",[s.required]],supplierId:["",[s.required]],purchaseDate:["",[s.required]],dueDate:[""],items:this.fb.array([]),paidAmount:[0],paymentStatus:["pending"]}),this.loadSuppliers(),this.loadDrugs(),this.isEdit&&this.purchaseId&&this.loadPurchase()}loadSuppliers(){this.suppliersService.getAll({page:1,pageSize:100}).subscribe({next:e=>{this.suppliers=e.data,this.supplierOptions=this.suppliers.map(r=>({value:r.id,label:r.name}))}})}loadDrugs(){this.drugsService.getPharmacyDrugs().subscribe({next:e=>{this.pharmacyDrugs=Array.isArray(e)?e:e.data,this.drugOptions=this.pharmacyDrugs.map(r=>({value:r.id,label:r.generalDrug?.name||"Drug "+r.id}))}})}loadPurchase(){this.purchasesService.getById(this.purchaseId).subscribe({next:e=>{e&&(this.purchaseForm.patchValue({invoiceNumber:e.invoiceNumber,supplierId:e.supplierId,purchaseDate:this.formatDateForInput(e.purchaseDate),dueDate:e.dueDate?this.formatDateForInput(e.dueDate):"",paidAmount:e.paidAmount,paymentStatus:e.paymentStatus}),e.items.forEach(r=>{this.addItemWithData(r)}))},error:()=>{this.errorMessage="error.loadPurchase"}})}addItem(){let e=this.fb.group({drugId:["",[s.required]],quantity:[1,[s.required,s.min(1)]],unitCost:[0,[s.required,s.min(0)]]});this.itemsArray.push(e)}addItemWithData(e){let r=this.fb.group({drugId:[e.drugId,[s.required]],quantity:[e.quantity,[s.required,s.min(1)]],unitCost:[e.unitCost,[s.required,s.min(0)]]});this.itemsArray.push(r)}removeItem(e){this.itemsArray.removeAt(e)}onSubmit(){if(this.purchaseForm.valid&&this.itemsArray.length>0){this.loading=!0,this.errorMessage="";let e=this.purchaseForm.value,r=e.items.map(m=>({drugId:m.drugId,quantity:m.quantity,unitCost:m.unitCost,totalCost:m.quantity*m.unitCost})),t={invoiceNumber:e.invoiceNumber,supplierId:e.supplierId,purchaseDate:new Date(e.purchaseDate),dueDate:e.dueDate?new Date(e.dueDate):void 0,items:r,totalAmount:this.totalAmount,paidAmount:e.paidAmount||0,remainingAmount:this.remainingAmount,paymentStatus:e.paymentStatus,pharmacyId:"ph1"};(this.isEdit?this.purchasesService.update(this.purchaseId,t):this.purchasesService.create(t)).subscribe({next:()=>{this.router.navigate(["/purchases"])},error:m=>{this.errorMessage=m.message||"error.savePurchase",this.loading=!1}})}else Object.keys(this.purchaseForm.controls).forEach(e=>{this.purchaseForm.get(e)?.markAsTouched()})}onCancel(){this.router.navigate(["/purchases"])}formatDateForInput(e){let r=new Date(e),t=r.getFullYear(),d=String(r.getMonth()+1).padStart(2,"0"),m=String(r.getDate()).padStart(2,"0");return`${t}-${d}-${m}`}static \u0275fac=function(r){return new(r||l)};static \u0275cmp=A({type:l,selectors:[["app-purchase-form"]],decls:54,vars:48,consts:[[3,"title","description","errorMessage"],[1,"p-8",3,"ngSubmit","formGroup"],[3,"title"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-6"],["type","text","formControlName","invoiceNumber","prefixIcon","receipt",3,"label","required"],["formControlName","supplierId","prefixIcon","factory",3,"label","required","options","placeholder"],["type","date","formControlName","purchaseDate","prefixIcon","calendar",3,"label","required"],["type","date","formControlName","dueDate","prefixIcon","calendar",3,"label"],[1,"flex","items-center","justify-between","mb-6"],[1,"text-lg","font-semibold","text-gray-700"],["type","button",1,"px-4","py-2","border-2","border-gray-300","text-gray-700","rounded-lg","font-medium","hover:bg-gray-50","hover:border-gray-400","transition-all","duration-200","flex","items-center","gap-2",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 4v16m8-8H4"],["formArrayName","items",1,"space-y-4"],[1,"grid","grid-cols-1","md:grid-cols-5","gap-4","p-4","bg-gray-50","rounded-xl","border","border-gray-200",3,"formGroupName"],[1,"mt-6","p-4","bg-gray-50","rounded-xl","border","border-gray-200"],[1,"flex","justify-between","items-center"],[1,"text-lg","font-semibold","text-gray-900"],[1,"text-lg","font-bold","text-gray-900"],[1,"grid","grid-cols-1","md:grid-cols-3","gap-6"],["type","number","formControlName","paidAmount","prefixIcon","currency-dollar",3,"label","step","min"],["formControlName","paymentStatus","prefixIcon","check-circle",3,"label","options","placeholder"],[1,"w-full","p-4","bg-gray-50","rounded-xl","border","border-gray-200"],[1,"text-sm","text-gray-600","mb-1"],[1,"flex","items-center","justify-end","gap-4","pt-8","border-t-2","border-gray-100"],["type","button",1,"px-6","py-3","border-2","border-gray-300","text-gray-700","rounded-xl","font-semibold","hover:bg-gray-50","hover:border-gray-400","transition-all","duration-200",3,"click"],["type","submit",1,"px-6","py-3","rounded-xl","font-semibold","hover:shadow-xl","hover:scale-105","active:scale-95","disabled:opacity-50","disabled:cursor-not-allowed","disabled:hover:scale-100","disabled:hover:shadow-none","transition-all","duration-200","flex","items-center","gap-2",3,"disabled"],["fill","none","viewBox","0 0 24 24",1,"animate-spin","h-5","w-5"],[1,"md:col-span-2"],["formControlName","drugId","prefixIcon","medicine",3,"label","options","placeholder"],["type","number","formControlName","quantity","prefixIcon","package",3,"label","min"],["type","number","formControlName","unitCost","prefixIcon","currency-dollar",3,"label","step","min"],[1,"flex","items-end"],["type","button",1,"w-full","px-4","py-2","text-red-600","hover:bg-red-50","rounded-lg","transition-all","duration-200",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5","mx-auto"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"],["cx","12","cy","12","r","10","stroke","currentColor","stroke-width","4",1,"opacity-25"],["fill","currentColor","d","M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z",1,"opacity-75"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M5 13l4 4L19 7"]],template:function(r,t){r&1&&(a(0,"app-modern-form-wrapper",0)(1,"form",1),v("ngSubmit",function(){return t.onSubmit()}),a(2,"app-form-section",2)(3,"div",3)(4,"div"),p(5,"app-text-input",4),o(),a(6,"div"),p(7,"app-autocomplete-input",5),o(),a(8,"div"),p(9,"app-text-input",6),o(),a(10,"div"),p(11,"app-text-input",7),o()()(),a(12,"app-form-section",2)(13,"div",8)(14,"h4",9),u(15),h(16,"translate"),o(),a(17,"button",10),v("click",function(){return t.addItem()}),f(),a(18,"svg",11),p(19,"path",12),o(),u(20),h(21,"translate"),o()(),C(),a(22,"div",13),k(23,te,11,9,"div",14,E),o(),a(25,"div",15)(26,"div",16)(27,"span",17),u(28),h(29,"translate"),o(),a(30,"span",18),u(31),o()()()(),a(32,"app-form-section",2)(33,"div",19)(34,"div"),p(35,"app-text-input",20),o(),a(36,"div"),p(37,"app-autocomplete-input",21),o(),a(38,"div")(39,"div",22)(40,"div",23),u(41),h(42,"translate"),o(),a(43,"div",17),u(44),o()()()()(),a(45,"div",24)(46,"button",25),v("click",function(){return t.onCancel()}),u(47),h(48,"translate"),o(),a(49,"button",26),F(50,re,3,0,":svg:svg",27)(51,ie,2,0,":svg:svg",11),u(52),h(53,"translate"),o()()()()),r&2&&(n("title",t.isEdit?"form.editPurchase":"form.addPurchase")("description",t.isEdit?"form.editPurchaseDescription":"form.addPurchaseDescription")("errorMessage",t.errorMessage),i(),n("formGroup",t.purchaseForm),i(),n("title","purchase.basicInfo"),i(3),n("label","form.purchase.invoiceNumber")("required",!0),i(2),n("label","form.purchase.supplier")("required",!0)("options",t.supplierOptions)("placeholder","form.selectSupplier"),i(2),n("label","form.purchase.purchaseDate")("required",!0),i(2),n("label","form.purchase.dueDate"),i(),n("title","purchase.items"),i(3),y(g(16,36,"form.purchase.addItems")),i(5),b(" ",g(21,38,"form.purchase.addItem")," "),i(3),N(t.itemsArray.controls),i(5),b("",g(29,40,"form.purchase.totalAmount"),":"),i(3),y(t.formattedTotalAmount),i(),n("title","purchase.paymentInfo"),i(3),n("label","form.purchase.paidAmount")("step",.01)("min",0),i(2),n("label","form.purchase.paymentStatus")("options",t.paymentStatusOptions)("placeholder","form.selectPaymentStatus"),i(4),y(g(42,42,"form.purchase.remainingAmount")),i(3),y(t.formattedRemainingAmount),i(3),b(" ",g(48,44,"common.cancel")," "),i(2),D("background","var(--primary-bg)")("color","var(--primary-text)"),n("disabled",t.purchaseForm.invalid||t.itemsArray.length===0||t.loading),i(),_(t.loading?50:51),i(2),b(" ",g(53,46,t.isEdit?"form.updatePurchase":"form.createPurchase")," "))},dependencies:[q,W,G,T,V,H,B,R,j,$,L,K,Q,J,Y,O],encapsulation:2})};export{ee as PurchaseFormComponent};
