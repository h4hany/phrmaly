import{a as v}from"./chunk-3NBSZF5I.js";import{a as u}from"./chunk-T542ZMY7.js";import{K as l,Q as m,i as o,y as c}from"./chunk-E4S7NVXB.js";import{a as d,b as p}from"./chunk-C6Q5SG76.js";var h=class f{pharmacyContextService=m(u);eventBus=m(v);movements=[{id:"MOV001",pharmacyId:"ph1",drugId:"PDRG001",drugName:"Paracetamol 500mg",movementType:"sale",quantity:-5,previousQuantity:150,newQuantity:145,unitCost:3.5,staffId:"staff1",staffName:"John Doe",riskLevel:"low",riskScore:15,timestamp:new Date("2024-11-27T10:30:00"),createdAt:new Date("2024-11-27T10:30:00"),createdBy:"staff1"},{id:"MOV002",pharmacyId:"ph1",drugId:"PDRG003",drugName:"Amoxicillin 250mg",movementType:"adjustment",quantity:-17,previousQuantity:25,newQuantity:8,unitCost:8,staffId:"staff2",staffName:"Jane Smith",reason:"Inventory correction",riskLevel:"high",riskScore:75,variance:-17,timestamp:new Date("2024-11-27T09:15:00"),createdAt:new Date("2024-11-27T09:15:00"),createdBy:"staff2"},{id:"MOV003",pharmacyId:"ph1",drugId:"PDRG002",drugName:"Ibuprofen 200mg",movementType:"purchase",quantity:50,previousQuantity:100,newQuantity:150,unitCost:5,staffId:"staff1",staffName:"John Doe",riskLevel:"low",riskScore:10,timestamp:new Date("2024-11-26T14:20:00"),createdAt:new Date("2024-11-26T14:20:00"),createdBy:"staff1"}];getMovements(e){let r=this.pharmacyContextService.getCurrentPharmacy()?.id;if(!r)return o({data:[],total:0,page:1,pageSize:10,totalPages:0}).pipe(c(300));let a=this.movements.filter(i=>i.pharmacyId===r);e?.drugId&&(a=a.filter(i=>i.drugId===e.drugId)),e?.staffId&&(a=a.filter(i=>i.staffId===e.staffId)),e?.movementType&&(a=a.filter(i=>i.movementType===e.movementType)),e?.riskLevel&&(a=a.filter(i=>i.riskLevel===e.riskLevel)),e?.startDate&&(a=a.filter(i=>i.timestamp>=e.startDate)),e?.endDate&&(a=a.filter(i=>i.timestamp<=e.endDate));let n=e?.page||1,t=e?.pageSize||10,s=(n-1)*t,y=s+t,g=a.slice(s,y);return o({data:g,total:a.length,page:n,pageSize:t,totalPages:Math.ceil(a.length/t)}).pipe(c(500))}getMovementById(e){let r=this.pharmacyContextService.getCurrentPharmacy()?.id;if(!r)return o(null).pipe(c(300));let a=this.movements.find(n=>n.id===e&&n.pharmacyId===r);return o(a||null).pipe(c(300))}recordMovement(e){let r=this.pharmacyContextService.getCurrentPharmacy()?.id;if(!r)throw new Error("No pharmacy context");let a=this.calculateRiskScore(e),n=this.getRiskLevel(a),t=p(d({},e),{id:`MOV${String(this.movements.length+1).padStart(3,"0")}`,pharmacyId:r,riskScore:a,riskLevel:n,timestamp:new Date,createdAt:new Date});return this.movements.push(t),this.eventBus.emit({type:"drug_movement",payload:t,source:"movement-engine"}),o(t).pipe(c(500))}getStaffRiskScores(){let e=this.pharmacyContextService.getCurrentPharmacy()?.id;if(!e)return o([]).pipe(c(300));let r=this.movements.filter(t=>t.pharmacyId===e),a=new Map;r.forEach(t=>{a.has(t.staffId)||a.set(t.staffId,{staffId:t.staffId,staffName:t.staffName||"Unknown",pharmacyId:e,totalMovements:0,suspiciousMovements:0,riskScore:0,riskLevel:"low"});let s=a.get(t.staffId);s.totalMovements++,(t.riskLevel==="high"||t.riskLevel==="critical")&&s.suspiciousMovements++,s.riskScore+=t.riskScore,(!s.lastMovementDate||t.timestamp>s.lastMovementDate)&&(s.lastMovementDate=t.timestamp)});let n=Array.from(a.values()).map(t=>(t.riskScore=t.totalMovements>0?t.riskScore/t.totalMovements:0,t.riskLevel=this.getRiskLevel(t.riskScore),t));return o(n).pipe(c(300))}calculateRiskScore(e){let r=0;return Math.abs(e.quantity)>50&&(r+=20),Math.abs(e.quantity)>100&&(r+=30),e.movementType==="adjustment"&&e.quantity<0&&(r+=40),e.variance&&Math.abs(e.variance)>10&&(r+=30),e.movementType==="theft"&&(r+=100),Math.min(r,100)}getRiskLevel(e){return e>=80?"critical":e>=60?"high":e>=30?"medium":"low"}static \u0275fac=function(r){return new(r||f)};static \u0275prov=l({token:f,factory:f.\u0275fac,providedIn:"root"})};export{h as a};
