import{a as ne}from"./chunk-VTYTIUDH.js";import{b as oe}from"./chunk-DYYETH2D.js";import{a as re}from"./chunk-J55IG6XL.js";import"./chunk-3H4DSHVM.js";import{a as te,b as ie}from"./chunk-4PK2EB7K.js";import"./chunk-P5TE6FOK.js";import{c as L,d as _,e as R,f as $,h as z,i as W,k as J,n as K,s as Q,v as X,w as Y,x as Z}from"./chunk-VW37JDOU.js";import{a as ee}from"./chunk-YUKQXM5O.js";import"./chunk-M3W4QUEG.js";import"./chunk-BYXBJQAS.js";import{b as j,d as q}from"./chunk-QHH3SHC3.js";import"./chunk-KPWAPXFF.js";import{b as H}from"./chunk-7DC7YEPQ.js";import{$ as k,$a as o,$b as A,Bb as c,Cb as u,Ga as M,La as x,Ra as m,S as f,Sa as T,Ta as S,Wa as g,Y as N,Z as E,Za as U,_ as F,_a as B,ab as a,bb as v,db as O,eb as C,fb as P,la as I,nb as p,ob as y,pb as b,qb as G,wa as D,xa as r}from"./chunk-OKFD3A6M.js";import"./chunk-KAT7YFEL.js";var le=(n,t)=>t.id;function se(n,t){if(n&1){let i=O();o(0,"div",26),C("click",function(){let l=N(i).$implicit,s=P(2);return E(s.selectPatient(l))}),p(1),a()}if(n&2){let i=t.$implicit;r(),G(" ",i.fullName," - ",i.phone," ")}}function pe(n,t){if(n&1&&(o(0,"div",8),U(1,se,2,2,"div",25,le),a()),n&2){let i=P();r(),B(i.filteredPatients)}}function ce(n,t){n&1&&(o(0,"p",9),p(1),c(2,"translate"),a()),n&2&&(r(),y(u(2,1,"voucher.patientRequired")))}function ue(n,t){n&1&&(o(0,"p",9),p(1),c(2,"translate"),a()),n&2&&(r(),y(u(2,1,"voucher.amountRequired")))}function de(n,t){n&1&&(o(0,"p",9),p(1),c(2,"translate"),a()),n&2&&(r(),y(u(2,1,"voucher.validUntilRequired")))}function me(n,t){n&1&&(F(),o(0,"svg",18),v(1,"circle",27)(2,"path",28),a())}function he(n,t){n&1&&(F(),o(0,"svg",19),v(1,"path",29),a())}function ve(n,t){if(n&1&&(o(0,"div",23),v(1,"app-voucher-card",30),a()),n&2){let i=P();r(),m("voucher",i.previewVoucher)("averageDiscountPercentage",0)}}function fe(n,t){n&1&&(o(0,"div",24)(1,"div",31),F(),o(2,"svg",32),v(3,"path",33)(4,"path",34),a(),k(),o(5,"p"),p(6),c(7,"translate"),a()()()),n&2&&(r(6),y(u(7,1,"voucher.fillFormToPreview")))}var ae=class n{fb=f(X);router=f(q);route=f(j);vouchersService=f(ne);patientsService=f(re);pharmacyContextService=f(ee);voucherForm;loading=!1;errorMessage="";isEdit=!1;voucherId=null;patients=[];filteredPatients=[];showPatientDropdown=!1;patientInput="";selectedPatient=I(null);pharmacy=I(null);previewVoucherData=I(null);get previewVoucher(){return this.previewVoucherData()}ngOnInit(){this.voucherId=this.route.snapshot.paramMap.get("id"),this.isEdit=!!this.voucherId;let t=this.route.snapshot.queryParamMap.get("patientId"),i=this.pharmacyContextService.getCurrentPharmacy();this.pharmacy.set(i);let e=new Date;e.setMonth(e.getMonth()+3);let l=e.toISOString().split("T")[0];if(this.voucherForm=this.fb.group({patientId:[t||"",[_.required]],patientInput:[""],voucherName:[{value:"",disabled:!0}],amount:[0,[_.required,_.min(.01)]],validUntil:[l,[_.required]]}),this.voucherForm.get("patientId")?.valueChanges.subscribe(()=>{this.updateVoucherName(),this.updatePreview()}),this.voucherForm.get("validUntil")?.valueChanges.subscribe(()=>{this.updateVoucherName(),this.updatePreview()}),this.voucherForm.get("amount")?.valueChanges.subscribe(()=>{this.updatePreview()}),this.loadPatients(),this.isEdit&&this.voucherId&&this.loadVoucher(),t){let s=this.patients.find(d=>d.id===t);s&&(this.patientInput=s.fullName,this.selectedPatient.set(s),this.voucherForm.patchValue({patientInput:s.fullName}),this.updateVoucherName())}}generateVoucherName(t,i,e){if(!t||!i||!e)return"";let s=this.pharmacy()?.name||i,d=new Date(e).toISOString().split("T")[0].replace(/-/g,"");return`${t}-${s}-${d}`}updateVoucherName(){let t=this.voucherForm.get("patientId")?.value,i=this.voucherForm.get("validUntil")?.value,e=this.pharmacy();if(t&&i&&e){let l=this.generateVoucherName(t,e.id,i);this.voucherForm.patchValue({voucherName:l},{emitEvent:!1})}}updatePreview(){let t=this.selectedPatient(),i=this.pharmacy(),e=this.voucherForm?.value;if(!t||!i||!e?.amount||!e?.validUntil){this.previewVoucherData.set(null);return}let l=e.voucherName||this.generateVoucherName(t.id,i.id,e.validUntil),s=this.isEdit&&this.voucherId||Date.now().toString(36).toUpperCase(),d={voucherName:l,voucherCode:s,createdAt:this.isEdit&&this.voucherId?new Date:new Date,validUntil:new Date(e.validUntil),amount:e.amount,patient:t,pharmacy:i};this.previewVoucherData.set(d)}loadPatients(){this.patientsService.getAll({page:1,pageSize:100}).subscribe({next:t=>{this.patients=t.data,this.filteredPatients=[...this.patients];let i=this.route.snapshot.queryParamMap.get("patientId");if(i){let e=this.patients.find(l=>l.id===i);e&&(this.patientInput=e.fullName,this.selectedPatient.set(e),this.voucherForm.patchValue({patientId:e.id,patientInput:e.fullName}),this.updateVoucherName(),this.updatePreview())}}})}loadVoucher(){this.voucherId&&this.vouchersService.getById(this.voucherId).subscribe({next:t=>{t&&(this.patientInput=t.patient.fullName,this.selectedPatient.set(t.patient),this.voucherForm.patchValue({patientId:t.patient.id,patientInput:t.patient.fullName,voucherName:t.voucherName,amount:t.amount,validUntil:t.validUntil.toISOString().split("T")[0]}),this.updateVoucherName(),this.updatePreview())},error:()=>{this.errorMessage="error.loadVoucher"}})}onPatientInput(t){let i=t.target;if(this.patientInput=i.value,this.showPatientDropdown=!0,this.patientInput.trim()){let e=this.patientInput.toLowerCase();this.filteredPatients=this.patients.filter(l=>l.fullName.toLowerCase().includes(e)||l.phone.includes(e))}else this.filteredPatients=[...this.patients]}selectPatient(t){this.patientInput=t.fullName,this.selectedPatient.set(t),this.voucherForm.patchValue({patientId:t.id,patientInput:t.fullName}),this.showPatientDropdown=!1,this.updateVoucherName(),this.updatePreview()}onSubmit(){if(this.voucherForm.valid){this.loading=!0,this.errorMessage="";let t=this.voucherForm.value,i=this.pharmacyContextService.getCurrentPharmacy(),e=this.patients.find(h=>h.id===t.patientId);if(!i||!e){this.errorMessage="error.pharmacyOrPatientNotFound",this.loading=!1;return}let s={voucherName:t.voucherName||this.generateVoucherName(e.id,i.id,t.validUntil),voucherCode:this.isEdit?void 0:Date.now().toString(36).toUpperCase(),amount:t.amount,validUntil:new Date(t.validUntil),patient:e,pharmacy:i};(this.isEdit?this.vouchersService.update(this.voucherId,s):this.vouchersService.create(s)).subscribe({next:()=>{this.router.navigate(["/vouchers"])},error:h=>{this.errorMessage=h.message||"error.saveVoucher",this.loading=!1}})}else Object.keys(this.voucherForm.controls).forEach(t=>{this.voucherForm.get(t)?.markAsTouched()})}onCancel(){this.router.navigate(["/vouchers"])}onClickOutside(t){t.target.closest(".patient-dropdown-container")||(this.showPatientDropdown=!1)}static \u0275fac=function(i){return new(i||n)};static \u0275cmp=M({type:n,selectors:[["app-voucher-form"]],hostBindings:function(i,e){i&1&&C("click",function(s){return e.onClickOutside(s)},!1,D)},decls:63,vars:57,consts:[[3,"title","description","errorMessage"],[1,"p-8"],[1,"grid","grid-cols-1","lg:grid-cols-2","gap-8"],[1,"space-y-6",3,"ngSubmit","formGroup"],[3,"title"],[1,"block","text-sm","font-medium","text-gray-700","mb-2"],[1,"text-red-500"],["type","text","formControlName","patientInput",1,"w-full","px-4","py-3.5","pl-12","border-2","border-gray-200","rounded-xl","focus:outline-none","focus:ring-2","focus:ring-[var(--primary-color)]","focus:border-[var(--primary-color)]","transition-all","duration-200",3,"input","placeholder"],[1,"patient-dropdown-container","mt-2","border-2","border-gray-200","rounded-xl","bg-white","shadow-xl","max-h-60","overflow-y-auto"],[1,"mt-1","text-sm","text-red-500"],[1,"space-y-6"],["type","text","formControlName","voucherName",1,"w-full","px-4","py-3.5","pl-12","border-2","border-gray-200","rounded-xl","bg-gray-100","cursor-not-allowed",3,"placeholder","disabled"],[1,"mt-1","text-xs","text-gray-500"],["type","number","formControlName","amount","step","0.01","min","0",1,"w-full","px-4","py-3.5","pl-12","border-2","border-gray-200","rounded-xl","focus:outline-none","focus:ring-2","focus:ring-[var(--primary-color)]","focus:border-[var(--primary-color)]","transition-all","duration-200",3,"placeholder"],["type","date","formControlName","validUntil",1,"w-full","px-4","py-3.5","pl-12","border-2","border-gray-200","rounded-xl","focus:outline-none","focus:ring-2","focus:ring-[var(--primary-color)]","focus:border-[var(--primary-color)]","transition-all","duration-200"],[1,"flex","items-center","justify-end","gap-4","pt-8","border-t-2","border-gray-100"],["type","button",1,"px-6","py-3","border-2","border-gray-300","text-gray-700","rounded-xl","font-semibold","hover:bg-gray-50","hover:border-gray-400","transition-all","duration-200",3,"click"],["type","submit",1,"px-6","py-3","rounded-xl","font-semibold","hover:shadow-xl","hover:scale-105","active:scale-95","disabled:opacity-50","disabled:cursor-not-allowed","disabled:hover:scale-100","disabled:hover:shadow-none","transition-all","duration-200","flex","items-center","gap-2",3,"disabled"],["fill","none","viewBox","0 0 24 24",1,"animate-spin","h-5","w-5"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5"],[1,"sticky","top-8"],[1,"bg-white","rounded-2xl","shadow-xl","border","border-gray-100","p-6"],[1,"text-xl","font-bold","text-gray-900","mb-6"],[1,"flex","justify-center"],[1,"flex","items-center","justify-center","h-full","min-h-[600px]","text-gray-400"],[1,"px-4","py-3","hover:bg-gray-100","cursor-pointer","transition-colors","duration-200"],[1,"px-4","py-3","hover:bg-gray-100","cursor-pointer","transition-colors","duration-200",3,"click"],["cx","12","cy","12","r","10","stroke","currentColor","stroke-width","4",1,"opacity-25"],["fill","currentColor","d","M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z",1,"opacity-75"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M5 13l4 4L19 7"],[3,"voucher","averageDiscountPercentage"],[1,"text-center"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-16","h-16","mx-auto","mb-4","opacity-50"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M15 12a3 3 0 11-6 0 3 3 0 016 0z"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"]],template:function(i,e){if(i&1&&(o(0,"app-modern-form-wrapper",0)(1,"div",1)(2,"div",2)(3,"div")(4,"form",3),C("ngSubmit",function(){return e.onSubmit()}),o(5,"app-form-section",4)(6,"div")(7,"label",5),p(8),c(9,"translate"),o(10,"span",6),p(11,"*"),a()(),o(12,"input",7),c(13,"translate"),C("input",function(s){return e.onPatientInput(s)}),a(),x(14,pe,3,0,"div",8)(15,ce,3,3,"p",9),a()(),o(16,"app-form-section",4)(17,"div",10)(18,"div")(19,"label",5),p(20),c(21,"translate"),o(22,"span",6),p(23,"*"),a()(),v(24,"input",11),c(25,"translate"),o(26,"p",12),p(27),c(28,"translate"),a()(),o(29,"div")(30,"label",5),p(31),c(32,"translate"),o(33,"span",6),p(34,"*"),a()(),v(35,"input",13),c(36,"translate"),x(37,ue,3,3,"p",9),a(),o(38,"div")(39,"label",5),p(40),c(41,"translate"),o(42,"span",6),p(43,"*"),a()(),v(44,"input",14),x(45,de,3,3,"p",9),a()()(),o(46,"div",15)(47,"button",16),C("click",function(){return e.onCancel()}),p(48),c(49,"translate"),a(),o(50,"button",17),x(51,me,3,0,":svg:svg",18)(52,he,2,0,":svg:svg",19),p(53),c(54,"translate"),a()()()(),o(55,"div")(56,"div",20)(57,"div",21)(58,"h2",22),p(59),c(60,"translate"),a(),x(61,ve,2,2,"div",23)(62,fe,8,3,"div",24),a()()()()()()),i&2){let l,s,d,h,V,w;m("title",e.isEdit?"voucher.edit":"voucher.create")("description",e.isEdit?"form.editVoucherDescription":"form.addVoucherDescription")("errorMessage",e.errorMessage),r(4),m("formGroup",e.voucherForm),r(),m("title","voucher.patientInfo"),r(3),b(" ",u(9,35,"voucher.patient")," "),r(4),S("border-red-500",((l=e.voucherForm.get("patientId"))==null?null:l.invalid)&&((l=e.voucherForm.get("patientId"))==null?null:l.touched)),m("placeholder",u(13,37,"voucher.selectPatient")),r(2),g(e.showPatientDropdown&&e.filteredPatients.length>0?14:-1),r(),g((s=e.voucherForm.get("patientId"))!=null&&s.invalid&&((s=e.voucherForm.get("patientId"))!=null&&s.touched)?15:-1),r(),m("title","voucher.details"),r(4),b(" ",u(21,39,"voucher.name")," "),r(4),m("placeholder",u(25,41,"voucher.namePlaceholder"))("disabled",!0),r(3),y(u(28,43,"voucher.nameAutoGenerated")),r(4),b(" ",u(32,45,"voucher.amount")," "),r(4),S("border-red-500",((d=e.voucherForm.get("amount"))==null?null:d.invalid)&&((d=e.voucherForm.get("amount"))==null?null:d.touched)),m("placeholder",u(36,47,"voucher.amountPlaceholder")),r(2),g((h=e.voucherForm.get("amount"))!=null&&h.invalid&&((h=e.voucherForm.get("amount"))!=null&&h.touched)?37:-1),r(3),b(" ",u(41,49,"voucher.validUntil")," "),r(4),S("border-red-500",((V=e.voucherForm.get("validUntil"))==null?null:V.invalid)&&((V=e.voucherForm.get("validUntil"))==null?null:V.touched)),r(),g((w=e.voucherForm.get("validUntil"))!=null&&w.invalid&&((w=e.voucherForm.get("validUntil"))!=null&&w.touched)?45:-1),r(3),b(" ",u(49,51,"common.cancel")," "),r(2),T("background","var(--primary-bg)")("color","var(--primary-text)"),m("disabled",e.voucherForm.invalid||e.loading),r(),g(e.loading?51:52),r(2),b(" ",u(54,53,e.isEdit?"common.update":"common.create")," "),r(6),y(u(60,55,"voucher.preview")),r(2),g(e.previewVoucher?61:62)}},dependencies:[A,Z,z,L,W,R,$,Q,J,K,Y,te,ie,H,oe],encapsulation:2})};export{ae as VoucherFormComponent};
