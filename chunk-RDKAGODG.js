import{a as k}from"./chunk-3GG4LG3P.js";import{a as A}from"./chunk-543QFZRG.js";import{a as T}from"./chunk-RI4HLURJ.js";import{a as D}from"./chunk-YUKQXM5O.js";import{A as s,M,S as d,j as c,n as I,o as b}from"./chunk-OKFD3A6M.js";var C=class p{pharmacyContextService=d(D);invoicesService=d(T);attendanceService=d(k);movementEngine=d(A);performanceMetrics=[{staffId:"ST001",staffName:"Sarah Johnson",pharmacyId:"ph1",period:{startDate:new Date("2024-11-01"),endDate:new Date("2024-11-30")},sales:{totalRevenue:45e3,totalInvoices:120,averageInvoiceValue:375,growthPercentage:15.5},errors:{invoiceEdits:3,inventoryAdjustments:1,auditFlags:0,totalErrors:4},attendance:{percentage:98,lateArrivals:1,absences:0},inventory:{movements:45,suspiciousMovements:0,riskScore:15},overallScore:92,performanceGrade:"A",riskLevel:"low",riskScore:15,trends:{sales:"up",errors:"stable",attendance:"up"},lastUpdated:new Date},{staffId:"ST002",staffName:"Michael Chen",pharmacyId:"ph1",period:{startDate:new Date("2024-11-01"),endDate:new Date("2024-11-30")},sales:{totalRevenue:32e3,totalInvoices:95,averageInvoiceValue:337,growthPercentage:8.2},errors:{invoiceEdits:8,inventoryAdjustments:3,auditFlags:1,totalErrors:12},attendance:{percentage:85,lateArrivals:5,absences:2},inventory:{movements:38,suspiciousMovements:2,riskScore:45},overallScore:72,performanceGrade:"C+",riskLevel:"medium",riskScore:45,trends:{sales:"up",errors:"up",attendance:"down"},lastUpdated:new Date}];activities=[{id:"ACT001",staffId:"ST001",staffName:"Sarah Johnson",pharmacyId:"ph1",type:"sale",entityType:"Invoice",entityId:"INV001",description:"Created invoice SALES-2024-001 for $500",timestamp:new Date("2024-11-27T10:30:00"),metadata:{amount:500}},{id:"ACT002",staffId:"ST001",staffName:"Sarah Johnson",pharmacyId:"ph1",type:"edit",entityType:"Invoice",entityId:"INV001",description:"Updated invoice SALES-2024-001",timestamp:new Date("2024-11-27T10:35:00")}];getPerformanceMetrics(e,r,a){let i=this.pharmacyContextService.getCurrentPharmacy()?.id;if(!i)throw new Error("No pharmacy selected");let n=this.performanceMetrics.find(t=>t.pharmacyId===i&&t.staffId===e&&t.period.startDate.getTime()===r.getTime()&&t.period.endDate.getTime()===a.getTime());return n?c(n).pipe(s(300)):b([this.invoicesService.getAll(),this.attendanceService.getAttendanceStats(e,r,a),this.movementEngine.getMovements({staffId:e,startDate:r,endDate:a,page:1,pageSize:1e3})]).pipe(I(([t,o,w])=>{let u=t.data.filter(m=>!0),v=u.reduce((m,F)=>m+F.total,0),f=u.length,P=f>0?v/f:0,h=w.data||[],g=h.filter(m=>m.riskLevel==="high"||m.riskLevel==="critical").length,l=Math.min(100,g/Math.max(h.length,1)*100),L=Math.min(100,v/5e4*100),E=o.attendancePercentage,x=Math.max(0,100-12*5),N=100-l,S=Math.round(L*.3+E*.25+x*.25+N*.2),R=this.calculateGrade(S),j=this.calculateRiskLevel(l),y={staffId:e,staffName:"",pharmacyId:i,period:{startDate:r,endDate:a},sales:{totalRevenue:v,totalInvoices:f,averageInvoiceValue:P,growthPercentage:0},errors:{invoiceEdits:0,inventoryAdjustments:0,auditFlags:0,totalErrors:0},attendance:{percentage:o.attendancePercentage,lateArrivals:o.lateDays,absences:o.absentDays},inventory:{movements:h.length,suspiciousMovements:g,riskScore:Math.round(l)},overallScore:S,performanceGrade:R,riskLevel:j,riskScore:Math.round(l),trends:{sales:"stable",errors:"stable",attendance:"stable"},lastUpdated:new Date};return this.performanceMetrics.push(y),y}),s(500))}getStaffActivities(e,r=50){let a=this.pharmacyContextService.getCurrentPharmacy()?.id;if(!a)return c([]).pipe(s(300));let i=this.activities.filter(n=>n.pharmacyId===a&&n.staffId===e).sort((n,t)=>t.timestamp.getTime()-n.timestamp.getTime()).slice(0,r);return c(i).pipe(s(300))}getPerformanceLeaderboard(e,r,a=10){let i=this.pharmacyContextService.getCurrentPharmacy()?.id;if(!i)return c([]).pipe(s(300));let n=this.performanceMetrics.filter(t=>t.pharmacyId===i&&t.period.startDate.getTime()===e.getTime()&&t.period.endDate.getTime()===r.getTime()).sort((t,o)=>o.overallScore-t.overallScore).slice(0,a);return c(n).pipe(s(500))}getRiskLeaderboard(e,r,a=10){let i=this.pharmacyContextService.getCurrentPharmacy()?.id;if(!i)return c([]).pipe(s(300));let n=this.performanceMetrics.filter(t=>t.pharmacyId===i&&t.period.startDate.getTime()===e.getTime()&&t.period.endDate.getTime()===r.getTime()).sort((t,o)=>o.riskScore-t.riskScore).slice(0,a);return c(n).pipe(s(500))}calculateGrade(e){return e>=97?"A+":e>=93?"A":e>=87?"B+":e>=83?"B":e>=77?"C+":e>=73?"C":e>=70?"D":"F"}calculateRiskLevel(e){return e>=75?"critical":e>=50?"high":e>=25?"medium":"low"}static \u0275fac=function(r){return new(r||p)};static \u0275prov=M({token:p,factory:p.\u0275fac,providedIn:"root"})};export{C as a};
