import{a as ie}from"./chunk-X7CGJDW6.js";import{b as ne}from"./chunk-3AOUMDXJ.js";import{a as te}from"./chunk-ZOZDUEMX.js";import"./chunk-ASC66LS3.js";import{a as Z}from"./chunk-XG6FMBJJ.js";import{c as L,d as V,e as R,f as $,h as z,i as J,k as K,n as Q,s as W,v as X,x as Y}from"./chunk-TK76J465.js";import{a as ee}from"./chunk-T542ZMY7.js";import"./chunk-URFUYTQU.js";import"./chunk-BYXBJQAS.js";import{b as H}from"./chunk-3UJCRMW3.js";import{b as G,d as j}from"./chunk-C3O3TVFX.js";import{$a as l,Ab as u,Bb as c,Fa as B,Ka as x,Q as g,Qa as v,Ra as U,Sa as S,Va as f,W as P,X as N,Y as E,Ya as k,Z as D,Za as M,_a as o,_b as q,ab as y,cb as A,db as b,eb as C,ja as w,mb as s,nb as _,ob as m,pb as O,va as T,wa as r}from"./chunk-E4S7NVXB.js";import"./chunk-C6Q5SG76.js";var oe=(n,e)=>e.id;function ae(n,e){if(n&1&&y(0,"app-alert",1),n&2){let i=C();v("title",i.errorMessage)}}function le(n,e){if(n&1){let i=A();o(0,"div",22),b("click",function(){let a=P(i).$implicit,p=C(2);return N(p.selectPatient(a))}),s(1),l()}if(n&2){let i=e.$implicit;r(),O(" ",i.fullName," - ",i.phone," ")}}function pe(n,e){if(n&1&&(o(0,"div",9),k(1,le,2,2,"div",21,oe),l()),n&2){let i=C();r(),M(i.filteredPatients)}}function se(n,e){n&1&&(o(0,"p",10),s(1),u(2,"translate"),l()),n&2&&(r(),_(c(2,1,"voucher.patientRequired")))}function ue(n,e){n&1&&(o(0,"p",10),s(1),u(2,"translate"),l()),n&2&&(r(),_(c(2,1,"voucher.amountRequired")))}function ce(n,e){n&1&&(o(0,"p",10),s(1),u(2,"translate"),l()),n&2&&(r(),_(c(2,1,"voucher.validUntilRequired")))}function de(n,e){n&1&&(s(0),u(1,"translate")),n&2&&m(" ",c(1,1,"common.saving")," ")}function me(n,e){if(n&1&&(s(0),u(1,"translate"),u(2,"translate")),n&2){let i=C();m(" ",i.isEdit?c(1,1,"common.update"):c(2,3,"common.create")," ")}}function he(n,e){if(n&1&&(o(0,"div",19),y(1,"app-voucher-card",23),l()),n&2){let i=C();r(),v("voucher",i.previewVoucher)("averageDiscountPercentage",0)}}function ve(n,e){n&1&&(o(0,"div",20)(1,"div",24),E(),o(2,"svg",25),y(3,"path",26)(4,"path",27),l(),D(),o(5,"p"),s(6),u(7,"translate"),l()()()),n&2&&(r(6),_(c(7,1,"voucher.fillFormToPreview")))}var re=class n{fb=g(X);router=g(j);route=g(G);vouchersService=g(ie);patientsService=g(te);pharmacyContextService=g(ee);voucherForm;loading=!1;errorMessage="";isEdit=!1;voucherId=null;patients=[];filteredPatients=[];showPatientDropdown=!1;patientInput="";selectedPatient=w(null);pharmacy=w(null);previewVoucherData=w(null);get previewVoucher(){return this.previewVoucherData()}ngOnInit(){this.voucherId=this.route.snapshot.paramMap.get("id"),this.isEdit=!!this.voucherId;let e=this.route.snapshot.queryParamMap.get("patientId"),i=this.pharmacyContextService.getCurrentPharmacy();this.pharmacy.set(i);let t=new Date;t.setMonth(t.getMonth()+3);let a=t.toISOString().split("T")[0];if(this.voucherForm=this.fb.group({patientId:[e||"",[V.required]],patientInput:[""],voucherName:[{value:"",disabled:!0}],amount:[0,[V.required,V.min(.01)]],validUntil:[a,[V.required]]}),this.voucherForm.get("patientId")?.valueChanges.subscribe(()=>{this.updateVoucherName(),this.updatePreview()}),this.voucherForm.get("validUntil")?.valueChanges.subscribe(()=>{this.updateVoucherName(),this.updatePreview()}),this.voucherForm.get("amount")?.valueChanges.subscribe(()=>{this.updatePreview()}),this.loadPatients(),this.isEdit&&this.voucherId&&this.loadVoucher(),e){let p=this.patients.find(d=>d.id===e);p&&(this.patientInput=p.fullName,this.selectedPatient.set(p),this.voucherForm.patchValue({patientInput:p.fullName}),this.updateVoucherName())}}generateVoucherName(e,i,t){if(!e||!i||!t)return"";let p=this.pharmacy()?.name||i,d=new Date(t).toISOString().split("T")[0].replace(/-/g,"");return`${e}-${p}-${d}`}updateVoucherName(){let e=this.voucherForm.get("patientId")?.value,i=this.voucherForm.get("validUntil")?.value,t=this.pharmacy();if(e&&i&&t){let a=this.generateVoucherName(e,t.id,i);this.voucherForm.patchValue({voucherName:a},{emitEvent:!1})}}updatePreview(){let e=this.selectedPatient(),i=this.pharmacy(),t=this.voucherForm?.value;if(!e||!i||!t?.amount||!t?.validUntil){this.previewVoucherData.set(null);return}let a=t.voucherName||this.generateVoucherName(e.id,i.id,t.validUntil),p=this.isEdit&&this.voucherId||Date.now().toString(36).toUpperCase(),d={voucherName:a,voucherCode:p,createdAt:this.isEdit&&this.voucherId?new Date:new Date,validUntil:new Date(t.validUntil),amount:t.amount,patient:e,pharmacy:i};this.previewVoucherData.set(d)}loadPatients(){this.patientsService.getAll({page:1,pageSize:100}).subscribe({next:e=>{this.patients=e.data,this.filteredPatients=[...this.patients];let i=this.route.snapshot.queryParamMap.get("patientId");if(i){let t=this.patients.find(a=>a.id===i);t&&(this.patientInput=t.fullName,this.selectedPatient.set(t),this.voucherForm.patchValue({patientId:t.id,patientInput:t.fullName}),this.updateVoucherName(),this.updatePreview())}}})}loadVoucher(){this.voucherId&&this.vouchersService.getById(this.voucherId).subscribe({next:e=>{e&&(this.patientInput=e.patient.fullName,this.selectedPatient.set(e.patient),this.voucherForm.patchValue({patientId:e.patient.id,patientInput:e.patient.fullName,voucherName:e.voucherName,amount:e.amount,validUntil:e.validUntil.toISOString().split("T")[0]}),this.updateVoucherName(),this.updatePreview())},error:()=>{this.errorMessage="Failed to load voucher"}})}onPatientInput(e){let i=e.target;if(this.patientInput=i.value,this.showPatientDropdown=!0,this.patientInput.trim()){let t=this.patientInput.toLowerCase();this.filteredPatients=this.patients.filter(a=>a.fullName.toLowerCase().includes(t)||a.phone.includes(t))}else this.filteredPatients=[...this.patients]}selectPatient(e){this.patientInput=e.fullName,this.selectedPatient.set(e),this.voucherForm.patchValue({patientId:e.id,patientInput:e.fullName}),this.showPatientDropdown=!1,this.updateVoucherName(),this.updatePreview()}onSubmit(){if(this.voucherForm.valid){this.loading=!0,this.errorMessage="";let e=this.voucherForm.value,i=this.pharmacyContextService.getCurrentPharmacy(),t=this.patients.find(h=>h.id===e.patientId);if(!i||!t){this.errorMessage="Pharmacy or patient not found",this.loading=!1;return}let p={voucherName:e.voucherName||this.generateVoucherName(t.id,i.id,e.validUntil),voucherCode:this.isEdit?void 0:Date.now().toString(36).toUpperCase(),amount:e.amount,validUntil:new Date(e.validUntil),patient:t,pharmacy:i};(this.isEdit?this.vouchersService.update(this.voucherId,p):this.vouchersService.create(p)).subscribe({next:()=>{this.router.navigate(["/vouchers"])},error:h=>{this.errorMessage=h.message||"An error occurred while saving",this.loading=!1}})}else Object.keys(this.voucherForm.controls).forEach(e=>{this.voucherForm.get(e)?.markAsTouched()})}onCancel(){this.router.navigate(["/vouchers"])}onClickOutside(e){e.target.closest(".patient-dropdown-container")||(this.showPatientDropdown=!1)}static \u0275fac=function(i){return new(i||n)};static \u0275cmp=B({type:n,selectors:[["app-voucher-form"]],hostBindings:function(i,t){i&1&&b("click",function(p){return t.onClickOutside(p)},!1,T)},decls:60,vars:55,consts:[[1,"space-y-6"],["type","error",3,"title"],[1,"grid","grid-cols-1","lg:grid-cols-2","gap-6"],[1,"bg-[var(--card-bg)]","rounded-[var(--radius-lg)]","shadow-[var(--shadow-sm)]","p-6"],[1,"text-2xl","font-bold","text-[var(--text-primary)]","mb-6"],[1,"space-y-6",3,"ngSubmit","formGroup"],[1,"block","text-sm","font-medium","text-[var(--card-text)]","mb-2"],[1,"text-red-500"],["type","text","formControlName","patientInput",1,"w-full","px-4","py-2","border","border-gray-300","rounded-lg","focus:outline-none","focus:ring-2","focus:ring-[var(--primary-color)]",3,"input","placeholder"],[1,"patient-dropdown-container","mt-2","border","border-gray-300","rounded-lg","bg-white","shadow-lg","max-h-60","overflow-y-auto"],[1,"mt-1","text-sm","text-red-500"],["type","text","formControlName","voucherName",1,"w-full","px-4","py-2","border","border-gray-300","rounded-lg","bg-gray-100","cursor-not-allowed",3,"placeholder","disabled"],[1,"mt-1","text-xs","text-gray-500"],["type","number","formControlName","amount","step","0.01","min","0",1,"w-full","px-4","py-2","border","border-gray-300","rounded-lg","focus:outline-none","focus:ring-2","focus:ring-[var(--primary-color)]",3,"placeholder"],["type","date","formControlName","validUntil",1,"w-full","px-4","py-2","border","border-gray-300","rounded-lg","focus:outline-none","focus:ring-2","focus:ring-[var(--primary-color)]"],[1,"flex","items-center","justify-end","gap-4","pt-6","border-t","border-gray-200"],["type","button",1,"px-6","py-3","border-2","border-gray-300","text-gray-700","rounded-xl","font-semibold","hover:bg-gray-50","transition-all","duration-200",3,"click"],["type","submit",1,"px-6","py-3","rounded-xl","font-semibold","transition-all","duration-200","disabled:opacity-50","disabled:cursor-not-allowed",3,"disabled"],[1,"text-xl","font-bold","text-[var(--text-primary)]","mb-4"],[1,"flex","justify-center"],[1,"flex","items-center","justify-center","h-full","min-h-[600px]","text-gray-400"],[1,"px-4","py-2","hover:bg-gray-100","cursor-pointer"],[1,"px-4","py-2","hover:bg-gray-100","cursor-pointer",3,"click"],[3,"voucher","averageDiscountPercentage"],[1,"text-center"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-16","h-16","mx-auto","mb-4","opacity-50"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M15 12a3 3 0 11-6 0 3 3 0 016 0z"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"]],template:function(i,t){if(i&1&&(o(0,"div",0),x(1,ae,1,1,"app-alert",1),o(2,"div",2)(3,"div",3)(4,"h1",4),s(5),u(6,"translate"),u(7,"translate"),l(),o(8,"form",5),b("ngSubmit",function(){return t.onSubmit()}),o(9,"div")(10,"label",6),s(11),u(12,"translate"),o(13,"span",7),s(14,"*"),l()(),o(15,"input",8),u(16,"translate"),b("input",function(p){return t.onPatientInput(p)}),l(),x(17,pe,3,0,"div",9)(18,se,3,3,"p",10),l(),o(19,"div")(20,"label",6),s(21),u(22,"translate"),o(23,"span",7),s(24,"*"),l()(),y(25,"input",11),u(26,"translate"),o(27,"p",12),s(28),u(29,"translate"),l()(),o(30,"div")(31,"label",6),s(32),u(33,"translate"),o(34,"span",7),s(35,"*"),l()(),y(36,"input",13),u(37,"translate"),x(38,ue,3,3,"p",10),l(),o(39,"div")(40,"label",6),s(41),u(42,"translate"),o(43,"span",7),s(44,"*"),l()(),y(45,"input",14),x(46,ce,3,3,"p",10),l(),o(47,"div",15)(48,"button",16),b("click",function(){return t.onCancel()}),s(49),u(50,"translate"),l(),o(51,"button",17),x(52,de,2,3)(53,me,3,5),l()()()(),o(54,"div",3)(55,"h2",18),s(56),u(57,"translate"),l(),x(58,he,2,2,"div",19)(59,ve,8,3,"div",20),l()()()),i&2){let a,p,d,h,I,F;r(),f(t.errorMessage?1:-1),r(4),m(" ",t.isEdit?c(6,31,"voucher.edit"):c(7,33,"voucher.create")," "),r(3),v("formGroup",t.voucherForm),r(3),m(" ",c(12,35,"voucher.patient")," "),r(4),S("border-red-500",((a=t.voucherForm.get("patientId"))==null?null:a.invalid)&&((a=t.voucherForm.get("patientId"))==null?null:a.touched)),v("placeholder",c(16,37,"voucher.selectPatient")),r(2),f(t.showPatientDropdown&&t.filteredPatients.length>0?17:-1),r(),f((p=t.voucherForm.get("patientId"))!=null&&p.invalid&&((p=t.voucherForm.get("patientId"))!=null&&p.touched)?18:-1),r(3),m(" ",c(22,39,"voucher.name")," "),r(4),v("placeholder",c(26,41,"voucher.namePlaceholder"))("disabled",!0),r(3),_(c(29,43,"voucher.nameAutoGenerated")),r(4),m(" ",c(33,45,"voucher.amount")," "),r(4),S("border-red-500",((d=t.voucherForm.get("amount"))==null?null:d.invalid)&&((d=t.voucherForm.get("amount"))==null?null:d.touched)),v("placeholder",c(37,47,"voucher.amountPlaceholder")),r(2),f((h=t.voucherForm.get("amount"))!=null&&h.invalid&&((h=t.voucherForm.get("amount"))!=null&&h.touched)?38:-1),r(3),m(" ",c(42,49,"voucher.validUntil")," "),r(4),S("border-red-500",((I=t.voucherForm.get("validUntil"))==null?null:I.invalid)&&((I=t.voucherForm.get("validUntil"))==null?null:I.touched)),r(),f((F=t.voucherForm.get("validUntil"))!=null&&F.invalid&&((F=t.voucherForm.get("validUntil"))!=null&&F.touched)?46:-1),r(3),m(" ",c(50,51,"common.cancel")," "),r(2),U("background","var(--primary-bg)")("color","var(--primary-text)"),v("disabled",t.voucherForm.invalid||t.loading),r(),f(t.loading?52:53),r(4),_(c(57,53,"voucher.preview")),r(2),f(t.previewVoucher?58:59)}},dependencies:[q,Y,z,L,J,R,$,W,K,Q,Z,H,ne],encapsulation:2})};export{re as VoucherFormComponent};
