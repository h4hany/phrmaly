import{a as _e}from"./chunk-PHYGXT4G.js";import{a as be}from"./chunk-FF46ICM6.js";import{a as he}from"./chunk-LNJRAZKD.js";import{c as Q,d as p,e as X,f as Y,g as Z,h as ee,i as te,j as ie,k as oe,l as re,m as ne,n as ae,o as de,p as se,q as le,t as ce,u as me,v as ue}from"./chunk-J4RW7IXS.js";import{a as ye}from"./chunk-PXA4LIDN.js";import{a as ge}from"./chunk-CLRJGXDB.js";import{a as ve}from"./chunk-K7KLI742.js";import{a as pe}from"./chunk-H653ED7N.js";import{b as fe}from"./chunk-7YN2F2UA.js";import{b as J,d as U}from"./chunk-J2A4D5WT.js";import{Da as z,Fa as R,Ia as I,K as H,Oa as u,Q as f,Ta as y,Ua as $,W as g,Wa as b,Wb as K,X as h,Xa as _,Y as N,Ya as r,Z as W,Za as o,_a as v,ab as x,bb as c,cb as m,da as q,e as j,ia as L,kb as a,lb as C,mb as D,nb as P,rb as w,sb as F,tb as E,ua as G,va as l,vb as k,yb as B,za as V,zb as M}from"./chunk-ILVQMZIM.js";import"./chunk-7CGTOI24.js";var S=class n{barcodeSubject=new j;barcode$=this.barcodeSubject.asObservable();barcodeBuffer="";bufferTimeout;constructor(){this.initializeBarcodeReader()}initializeBarcodeReader(){document.addEventListener("keypress",e=>{e.key&&e.key.length===1&&this.handleBarcodeInput(e.key)})}handleBarcodeInput(e){this.bufferTimeout&&clearTimeout(this.bufferTimeout),this.barcodeBuffer+=e,e===`
`||e==="\r"?(this.processBarcode(this.barcodeBuffer.trim()),this.barcodeBuffer=""):this.bufferTimeout=setTimeout(()=>{this.barcodeBuffer.length>=6&&this.processBarcode(this.barcodeBuffer.trim()),this.barcodeBuffer=""},100)}processBarcode(e){e.length>=6&&this.barcodeSubject.next(e)}scanBarcode(e){e&&e.length>=6&&this.barcodeSubject.next(e)}static \u0275fac=function(t){return new(t||n)};static \u0275prov=H({token:n,factory:n.\u0275fac,providedIn:"root"})};var T=class n{constructor(e,t){this.el=e;this.barcodeService=t;this.barcodeService.barcode$.subscribe(i=>{this.isElementFocused()&&this.barcodeScanned.emit(i)})}barcodeScanned=new q;barcodeBuffer="";bufferTimeout;onKeyDown(e){e.key&&e.key.length===1&&!e.ctrlKey&&!e.metaKey&&(this.bufferTimeout&&clearTimeout(this.bufferTimeout),this.barcodeBuffer+=e.key,this.bufferTimeout=setTimeout(()=>{this.barcodeBuffer=""},200))}onPaste(e){let t=e.clipboardData?.getData("text")||"";t.length>=6&&/^\d+$/.test(t)&&(e.preventDefault(),this.barcodeScanned.emit(t.trim()))}isElementFocused(){return document.activeElement===this.el.nativeElement||this.el.nativeElement.contains(document.activeElement)}static \u0275fac=function(t){return new(t||n)(V(L),V(S))};static \u0275dir=R({type:n,selectors:[["","appBarcodeScanner",""]],hostBindings:function(t,i){t&1&&c("keydown",function(d){return i.onKeyDown(d)})("paste",function(d){return i.onPaste(d)})},outputs:{barcodeScanned:"barcodeScanned"}})};var A=()=>({standalone:!0}),O=(n,e)=>e.id,Ie=(n,e)=>e.id||e.name;function De(n,e){if(n&1&&v(0,"app-alert",1),n&2){let t=m();u("title",t.errorMessage)}}function we(n,e){if(n&1&&(r(0,"option",8),a(1),o()),n&2){let t=e.$implicit;u("value",t.id),l(),C(t.fullName)}}function Fe(n,e){if(n&1){let t=x();r(0,"button",48),c("click",function(){let s=g(t).$implicit,d=m(3);return h(d.selectDoctor(s))}),a(1),o()}if(n&2){let t=e.$implicit;l(),D(" ",t.name," ")}}function Ee(n,e){if(n&1&&b(0,Fe,2,1,"button",47,Ie),n&2){let t=m(2);_(t.filteredDoctors)}}function ke(n,e){if(n&1){let t=x();r(0,"button",49),c("click",function(){g(t);let s=m(2);return h(s.addNewDoctor())}),a(1),B(2,"translate"),o()}if(n&2){let t=m(2);l(),P(" ",M(2,2,"invoice.addNewDoctor"),": ",t.doctorInput," ")}}function Be(n,e){if(n&1){let t=x();r(0,"button",48),c("click",function(){let s=g(t).$implicit,d=m(3);return h(d.selectDoctor(s))}),a(1),o()}if(n&2){let t=e.$implicit;l(),D(" ",t.name," ")}}function Me(n,e){if(n&1&&b(0,Be,2,1,"button",47,O),n&2){let t=m(2);_(t.doctors)}}function Te(n,e){if(n&1&&(r(0,"div",11),I(1,Ee,2,0)(2,ke,3,4,"button",46)(3,Me,2,0),o()),n&2){let t=m();l(),y(t.doctorInput.trim()&&t.filteredDoctors.length>0?1:-1),l(),y(t.doctorInput.trim()&&t.filteredDoctors.length===0?2:-1),l(),y(t.doctorInput.trim()?-1:3)}}function Ne(n,e){if(n&1&&(r(0,"option",8),a(1),o()),n&2){let t=e.$implicit;u("value",t.id),l(),P("",(t.generalDrug==null?null:t.generalDrug.name)||"Drug "+t.id," - ",t.price,"")}}function Ve(n,e){if(n&1){let t=x();r(0,"div",23)(1,"select",50),E("ngModelChange",function(s){g(t);let d=m();return F(d.selectedDrugId,s)||(d.selectedDrugId=s),h(s)}),r(2,"option",7),a(3,"Select Drug"),o(),b(4,Ne,2,3,"option",8,O),o(),r(6,"app-button",51),c("onClick",function(){g(t);let s=m();return h(s.addSelectedDrug())}),a(7,"Add"),o()()}if(n&2){let t=m();l(),w("ngModel",t.selectedDrugId),u("ngModelOptions",k(2,A)),l(3),_(t.pharmacyDrugs)}}function Pe(n,e){if(n&1){let t=x();r(0,"div",25)(1,"div",52)(2,"label",4),a(3,"Drug"),o(),v(4,"input",53),o(),r(5,"div")(6,"label",4),a(7,"Quantity"),o(),v(8,"input",54),o(),r(9,"div")(10,"label",4),a(11,"Unit Price"),o(),v(12,"input",55),o(),r(13,"div",56)(14,"button",57),c("click",function(){let s=g(t).$index,d=m();return h(d.removeItem(s))}),N(),r(15,"svg",58),v(16,"path",59),o()()()()}if(n&2){let t,i=e.$implicit,s=e.$index,d=m();u("formGroupName",s),l(4),u("value",d.getDrugName((t=i.get("drugId"))==null?null:t.value))}}var Ce=class n{fb=f(ce);router=f(U);route=f(J);invoicesService=f(ye);patientsService=f(ge);drugsService=f(be);bundlesService=f(_e);barcodeService=f(S);invoiceForm;loading=!1;errorMessage="";isEdit=!1;invoiceId=null;patients=[];pharmacyDrugs=[];barcodeInput="";showDrugSelector=!1;selectedDrugId="";doctorInput="";showDoctorDropdown=!1;doctors=[{id:"DOC001",name:"Dr. John Smith"},{id:"DOC002",name:"Dr. Jane Doe"},{id:"DOC003",name:"Dr. Michael Johnson"},{id:"DOC004",name:"Dr. Sarah Williams"}];filteredDoctors=[];selectedDoctor=null;get itemsArray(){return this.invoiceForm.get("items")}get subtotal(){return this.itemsArray.value.reduce((t,i)=>t+(i.quantity*i.unitPrice||0),0)}get discount(){return this.invoiceForm.get("discount")?.value||0}get total(){return Math.max(0,this.subtotal-this.discount)}get formattedSubtotal(){return this.subtotal.toFixed(2)}get formattedDiscount(){return this.discount.toFixed(2)}get formattedTotal(){return this.total.toFixed(2)}ngOnInit(){this.invoiceId=this.route.snapshot.paramMap.get("id"),this.isEdit=!!this.invoiceId,this.invoiceForm=this.fb.group({patientId:["",[p.required]],promoCode:[""],items:this.fb.array([]),discount:[0],paymentStatus:["pending"],paymentMethod:[""],doctor:[null]}),this.loadPatients(),this.loadDrugs(),this.isEdit&&this.invoiceId&&this.loadInvoice()}loadPatients(){this.patientsService.getAll({page:1,pageSize:100}).subscribe({next:e=>{this.patients=e.data}})}loadDrugs(){this.drugsService.getPharmacyDrugs({page:1,pageSize:100}).subscribe({next:e=>{this.pharmacyDrugs=e.data}})}loadInvoice(){this.invoicesService.getById(this.invoiceId).subscribe({next:e=>{e&&(this.invoiceForm.patchValue({patientId:e.patientId,promoCode:e.promoCode||"",discount:e.discount,paymentStatus:e.paymentStatus,paymentMethod:e.paymentMethod||""}),e.items.forEach(t=>{this.addItemWithData(t)}))},error:()=>{this.errorMessage="Failed to load invoice"}})}onBarcodeScanned(e){this.addItemByBarcode(e)}addItemByBarcode(e){let t=e||this.barcodeInput.trim();t&&this.drugsService.getPharmacyDrugByBarcode(t).subscribe({next:i=>{i?(this.addItemWithDrug(i),this.barcodeInput=""):this.errorMessage="Drug not found for barcode: "+t},error:()=>{this.errorMessage="Failed to search drug"}})}addSelectedDrug(){if(!this.selectedDrugId)return;let e=this.pharmacyDrugs.find(t=>t.id===this.selectedDrugId);e&&(this.addItemWithDrug(e),this.selectedDrugId="",this.showDrugSelector=!1)}addItemWithDrug(e){let t=this.fb.group({drugId:[e.id,[p.required]],quantity:[1,[p.required,p.min(1)]],unitPrice:[e.price,[p.required]]});this.itemsArray.push(t)}addItemWithData(e){let t=this.fb.group({drugId:[e.drugId,[p.required]],quantity:[e.quantity,[p.required,p.min(1)]],unitPrice:[e.unitPrice,[p.required]]});this.itemsArray.push(t)}removeItem(e){this.itemsArray.removeAt(e)}getDrugName(e){return this.pharmacyDrugs.find(i=>i.id===e)?.generalDrug?.name||"Unknown Drug"}onSubmit(){if(this.invoiceForm.valid&&this.itemsArray.length>0){this.loading=!0,this.errorMessage="";let e=this.invoiceForm.value,t=e.items.map(d=>({drugId:d.drugId,quantity:d.quantity,unitPrice:d.unitPrice,totalPrice:d.quantity*d.unitPrice})),i={patientId:e.patientId,items:t,subtotal:this.subtotal,discount:this.discount,promoCode:e.promoCode||void 0,total:this.total,paymentStatus:e.paymentStatus,paymentMethod:e.paymentMethod||void 0,pharmacyId:"ph1"};(this.isEdit?this.invoicesService.update(this.invoiceId,i):this.invoicesService.create(i)).subscribe({next:()=>{this.router.navigate(["/invoices"])},error:d=>{this.errorMessage=d.message||"An error occurred while saving",this.loading=!1}})}else Object.keys(this.invoiceForm.controls).forEach(e=>{this.invoiceForm.get(e)?.markAsTouched()})}onCancel(){this.router.navigate(["/invoices"])}onDoctorInput(e){let t=e.target;if(this.doctorInput=t.value,this.showDoctorDropdown=!0,this.doctorInput.trim()){let i=this.doctorInput.toLowerCase();this.filteredDoctors=this.doctors.filter(s=>s.name.toLowerCase().includes(i))}else this.filteredDoctors=[...this.doctors]}selectDoctor(e){this.doctorInput=e.name,this.selectedDoctor={doctorName:e.name,doctorId:e.id,isNewDoctor:!1},this.showDoctorDropdown=!1,this.invoiceForm.patchValue({doctor:this.selectedDoctor})}addNewDoctor(){let e=this.doctorInput.trim();e&&(this.selectedDoctor={doctorName:e,isNewDoctor:!0},this.showDoctorDropdown=!1,this.invoiceForm.patchValue({doctor:this.selectedDoctor}))}onClickOutside(e){e.target.closest(".doctor-dropdown-container")||(this.showDoctorDropdown=!1)}static \u0275fac=function(t){return new(t||n)};static \u0275cmp=z({type:n,selectors:[["app-invoice-form"]],hostBindings:function(t,i){t&1&&c("click",function(d){return i.onClickOutside(d)},!1,G)},decls:92,vars:23,consts:[[3,"title"],["type","error",3,"title"],[1,"space-y-6",3,"ngSubmit","formGroup"],[1,"grid","grid-cols-1","md:grid-cols-2","lg:grid-cols-4","gap-6"],[1,"block","text-sm","font-medium","text-gray-700","mb-1"],[1,"text-red-500"],["formControlName","patientId",1,"w-full","px-4","py-2.5","border","border-gray-300","rounded-[var(--radius-md)]","text-sm","focus:outline-none","focus:ring-2","focus:ring-[var(--primary-color)]"],["value",""],[3,"value"],[1,"relative","doctor-dropdown-container"],["type","text",1,"w-full","px-4","py-2.5","border","border-gray-300","rounded-[var(--radius-md)]","text-sm","focus:outline-none","focus:ring-2","focus:ring-[var(--primary-color)]",3,"ngModelChange","input","focus","ngModel","ngModelOptions","placeholder"],[1,"absolute","z-10","mt-1","w-full","bg-white","shadow-lg","max-h-60","rounded-[var(--radius-md)]","py-1","text-base","ring-1","ring-black","ring-opacity-5","overflow-auto"],["type","text","formControlName","promoCode","placeholder","Enter promo code",1,"w-full","px-4","py-2.5","border","border-gray-300","rounded-[var(--radius-md)]","text-sm","focus:outline-none","focus:ring-2","focus:ring-[var(--primary-color)]"],["type","number","formControlName","discount","placeholder","0.00","step","0.01","min","0",1,"w-full","px-4","py-2.5","border","border-gray-300","rounded-[var(--radius-md)]","text-sm","focus:outline-none","focus:ring-2","focus:ring-[var(--primary-color)]"],[1,"border-t","pt-6"],[1,"flex","items-center","justify-between","mb-4"],[1,"text-lg","font-medium","text-gray-900"],[1,"flex","gap-3"],[1,"relative"],["type","text","placeholder","Scan barcode or search...","appBarcodeScanner","",1,"w-64","pl-10","pr-4","py-2","border","border-gray-300","rounded-[var(--radius-md)]","text-sm","focus:outline-none","focus:ring-2","focus:ring-[var(--primary-color)]",3,"ngModelChange","keyup.enter","barcodeScanned","ngModel","ngModelOptions"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5","absolute","left-3","top-2.5","text-gray-400"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"],["type","button","variant","outline","size","sm",3,"onClick"],[1,"mb-4","p-4","bg-gray-50","rounded-[var(--radius-md)]"],["formArrayName","items",1,"space-y-4"],[1,"grid","grid-cols-1","md:grid-cols-5","gap-4","p-4","bg-gray-50","rounded-[var(--radius-md)]",3,"formGroupName"],[1,"mt-4","p-4","bg-gray-50","rounded-[var(--radius-md)]","space-y-2"],[1,"flex","justify-between"],[1,"text-gray-700"],[1,"font-medium"],[1,"flex","justify-between","pt-2","border-t"],[1,"text-lg","font-semibold","text-gray-900"],[1,"text-lg","font-bold","text-gray-900"],[1,"text-lg","font-medium","text-gray-900","mb-4"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-6"],["formControlName","paymentStatus",1,"w-full","px-4","py-2.5","border","border-gray-300","rounded-[var(--radius-md)]","text-sm","focus:outline-none","focus:ring-2","focus:ring-[var(--primary-color)]"],["value","pending"],["value","partial"],["value","paid"],["formControlName","paymentMethod",1,"w-full","px-4","py-2.5","border","border-gray-300","rounded-[var(--radius-md)]","text-sm","focus:outline-none","focus:ring-2","focus:ring-[var(--primary-color)]"],["value","cash"],["value","card"],["value","bank_transfer"],[1,"flex","items-center","justify-end","gap-4","pt-6","border-t"],["type","button","variant","outline",3,"onClick"],["type","submit","variant","primary",3,"loading","disabled"],["type","button",1,"block","w-full","text-left","px-4","py-2","text-sm","hover:bg-gray-100","cursor-pointer","text-[var(--primary-color)]","font-medium"],["type","button",1,"block","w-full","text-left","px-4","py-2","text-sm","hover:bg-gray-100","cursor-pointer","text-gray-900"],["type","button",1,"block","w-full","text-left","px-4","py-2","text-sm","hover:bg-gray-100","cursor-pointer","text-gray-900",3,"click"],["type","button",1,"block","w-full","text-left","px-4","py-2","text-sm","hover:bg-gray-100","cursor-pointer","text-[var(--primary-color)]","font-medium",3,"click"],[1,"w-full","px-4","py-2.5","border","border-gray-300","rounded-[var(--radius-md)]","text-sm","mb-2",3,"ngModelChange","ngModel","ngModelOptions"],["type","button","variant","primary","size","sm",3,"onClick"],[1,"md:col-span-2"],["type","text","readonly","",1,"w-full","px-4","py-2.5","border","border-gray-300","rounded-[var(--radius-md)]","text-sm","bg-gray-100",3,"value"],["type","number","formControlName","quantity","min","1",1,"w-full","px-4","py-2.5","border","border-gray-300","rounded-[var(--radius-md)]","text-sm","focus:outline-none","focus:ring-2","focus:ring-[var(--primary-color)]"],["type","number","formControlName","unitPrice","step","0.01","readonly","",1,"w-full","px-4","py-2.5","border","border-gray-300","rounded-[var(--radius-md)]","text-sm","bg-gray-100"],[1,"flex","items-end"],["type","button",1,"p-2","text-red-600","hover:text-red-800",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"]],template:function(t,i){t&1&&(r(0,"app-form-wrapper",0),I(1,De,1,1,"app-alert",1),r(2,"form",2),c("ngSubmit",function(){return i.onSubmit()}),r(3,"div",3)(4,"div")(5,"label",4),a(6," Patient "),r(7,"span",5),a(8,"*"),o()(),r(9,"select",6)(10,"option",7),a(11,"Select Patient"),o(),b(12,we,2,2,"option",8,O),o()(),r(14,"div")(15,"label",4),a(16),B(17,"translate"),o(),r(18,"div",9)(19,"input",10),B(20,"translate"),E("ngModelChange",function(d){return F(i.doctorInput,d)||(i.doctorInput=d),d}),c("input",function(d){return i.onDoctorInput(d)})("focus",function(){return i.showDoctorDropdown=!0}),o(),I(21,Te,4,3,"div",11),o()(),r(22,"div")(23,"label",4),a(24,"Promo Code"),o(),v(25,"input",12),o(),r(26,"div")(27,"label",4),a(28,"Discount (Optional)"),o(),v(29,"input",13),o()(),r(30,"div",14)(31,"div",15)(32,"h3",16),a(33,"Items"),o(),r(34,"div",17)(35,"div",18)(36,"input",19),E("ngModelChange",function(d){return F(i.barcodeInput,d)||(i.barcodeInput=d),d}),c("keyup.enter",function(){return i.addItemByBarcode()})("barcodeScanned",function(d){return i.onBarcodeScanned(d)}),o(),N(),r(37,"svg",20),v(38,"path",21),o()(),W(),r(39,"app-button",22),c("onClick",function(){return i.showDrugSelector=!i.showDrugSelector}),a(40," Add Drug "),o()()(),I(41,Ve,8,3,"div",23),r(42,"div",24),b(43,Pe,17,2,"div",25,$),o(),r(45,"div",26)(46,"div",27)(47,"span",28),a(48,"Subtotal:"),o(),r(49,"span",29),a(50),o()(),r(51,"div",27)(52,"span",28),a(53,"Discount:"),o(),r(54,"span",29),a(55),o()(),r(56,"div",30)(57,"span",31),a(58,"Total:"),o(),r(59,"span",32),a(60),o()()()(),r(61,"div",14)(62,"h3",33),a(63,"Payment Information"),o(),r(64,"div",34)(65,"div")(66,"label",4),a(67,"Payment Status"),o(),r(68,"select",35)(69,"option",36),a(70,"Pending"),o(),r(71,"option",37),a(72,"Partial"),o(),r(73,"option",38),a(74,"Paid"),o()()(),r(75,"div")(76,"label",4),a(77,"Payment Method"),o(),r(78,"select",39)(79,"option",7),a(80,"Select Method"),o(),r(81,"option",40),a(82,"Cash"),o(),r(83,"option",41),a(84,"Card"),o(),r(85,"option",42),a(86,"Bank Transfer"),o()()()()(),r(87,"div",43)(88,"app-button",44),c("onClick",function(){return i.onCancel()}),a(89," Cancel "),o(),r(90,"app-button",45),a(91),o()()()()),t&2&&(u("title",i.isEdit?"Edit Sales Invoice":"Create New Sales Invoice"),l(),y(i.errorMessage?1:-1),l(),u("formGroup",i.invoiceForm),l(10),_(i.patients),l(4),C(M(17,17,"invoice.doctor")),l(3),w("ngModel",i.doctorInput),u("ngModelOptions",k(21,A))("placeholder",M(20,19,"form.selectOrType")),l(2),y(i.showDoctorDropdown?21:-1),l(15),w("ngModel",i.barcodeInput),u("ngModelOptions",k(22,A)),l(5),y(i.showDrugSelector?41:-1),l(2),_(i.itemsArray.controls),l(7),C(i.formattedSubtotal),l(5),C(i.formattedDiscount),l(5),C(i.formattedTotal),l(30),u("loading",i.loading)("disabled",i.invoiceForm.invalid||i.itemsArray.length===0),l(),D(" ",i.isEdit?"Update":"Create"," Invoice "))},dependencies:[K,ue,ee,de,se,Q,te,ae,X,Y,le,ie,ne,oe,re,me,Z,he,ve,pe,T,fe],encapsulation:2})};export{Ce as InvoiceFormComponent};
