<!-- Background Effects -->
<div class="bg-effects">
  <canvas #particleCanvas id="particleCanvas"></canvas>
  <div class="bg-gradient"></div>
  <div class="floating-shape shape-1"></div>
  <div class="floating-shape shape-2"></div>
</div>

<!-- Navigation -->
<nav class="navbar">
  <a routerLink="/" class="nav-brand" (click)="navigateToHome()">
    <div class="nav-logo">üíä</div>
    <span class="nav-brand-text">Pharmaly OS</span>
  </a>
  <div class="nav-actions">
    <button class="btn-language-toggle" (click)="toggleLanguage()" [attr.aria-label]="'common.changeLanguage' | translate">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
      </svg>
      <span>{{ currentLanguage === 'en' ? 'AR' : 'EN' }}</span>
    </button>
    <a routerLink="/" class="btn-nav" (click)="navigateToHome()">
      <span [attr.dir]="currentLanguage === 'ar' ? 'rtl' : 'ltr'">{{ currentLanguage === 'ar' ? '‚Üí' : '‚Üê' }}</span>
      {{ 'drugIndex.nav.backToHome' | translate }}
    </a>
    <a routerLink="/login" class="btn-nav" (click)="navigateToLogin()">{{ 'drugIndex.nav.login' | translate }}</a>
  </div>
</nav>

<!-- Main Container -->
<div class="container">
  <!-- Page Header -->
  <div class="page-header">
    <span class="page-badge">üîç {{ 'drugIndex.header.badge' | translate }}</span>
    <h1 class="page-title">{{ 'drugIndex.header.title' | translate }}</h1>
    <p class="page-subtitle">{{ 'drugIndex.header.subtitle' | translate }}</p>
  </div>

  <!-- Search Section -->
  <div class="search-section">
    <div class="search-container">
      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
      <input 
        type="text" 
        class="search-input" 
        [(ngModel)]="searchTerm"
        (ngModelChange)="onSearchChange()"
        [placeholder]="'drugIndex.search.placeholder' | translate"
        autocomplete="off"
      >
    </div>

    <div class="filters">
      <div class="filter-group">
        <app-autocomplete-input
          [(ngModel)]="typeFilter"
          (optionSelected)="onFilterChange()"
          [label]="'drugIndex.filters.type'"
          [options]="typeOptions"
          [placeholder]="'drugIndex.filters.type'"
          prefixIcon="medicine"
        ></app-autocomplete-input>
      </div>

      <div class="filter-group">
        <app-autocomplete-input
          [(ngModel)]="manufacturerFilter"
          (optionSelected)="onFilterChange()"
          [label]="'drugIndex.filters.manufacturer'"
          [options]="manufacturerOptions"
          [placeholder]="'drugIndex.filters.manufacturer'"
          prefixIcon="box"
        ></app-autocomplete-input>
      </div>

      <div class="filter-group">
        <app-autocomplete-input
          [(ngModel)]="sortFilter"
          (optionSelected)="onSortChange()"
          [label]="'drugIndex.filters.sortBy'"
          [options]="sortOptions"
          [placeholder]="'drugIndex.filters.sortBy'"
          prefixIcon="chart"
        ></app-autocomplete-input>
      </div>
    </div>
  </div>

  <!-- Results Header -->
  <div class="results-header">
    <div class="results-count">
      {{ 'drugIndex.results.showing' | translate }} <span>{{ filteredDrugs.length }}</span> {{ 'drugIndex.results.drugs' | translate }}
    </div>
    <div class="view-toggle">
      <button class="view-btn" [class.active]="viewMode === 'grid'" (click)="setViewMode('grid')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
      </button>
      <button class="view-btn" [class.active]="viewMode === 'list'" (click)="setViewMode('list')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="8" y1="6" x2="21" y2="6"></line>
          <line x1="8" y1="12" x2="21" y2="12"></line>
          <line x1="8" y1="18" x2="21" y2="18"></line>
          <line x1="3" y1="6" x2="3.01" y2="6"></line>
          <line x1="3" y1="12" x2="3.01" y2="12"></line>
          <line x1="3" y1="18" x2="3.01" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading) {
    <div class="loading">
      <div class="loading-spinner"></div>
      <p>{{ 'drugIndex.loading' | translate }}</p>
    </div>
  }

  <!-- Empty State -->
  @if (!loading && filteredDrugs.length === 0) {
    <div class="empty-state">
      <div class="empty-icon">üîç</div>
      <div class="empty-title">{{ 'drugIndex.empty.title' | translate }}</div>
      <div class="empty-text">{{ 'drugIndex.empty.text' | translate }}</div>
    </div>
  }

  <!-- Drugs Grid -->
  @if (!loading && filteredDrugs.length > 0) {
    <div class="drugs-grid" [class.list-view]="viewMode === 'list'">
      @for (drug of filteredDrugs; track drug.id) {
        <div class="drug-card" (click)="openModal(drug)">
          <div class="drug-header">
            <div style="font-size: 32px;">{{ getTypeIcon(drug.type) }}</div>
            <span class="drug-type-badge">{{ drug.type || ('common.notAvailable' | translate) }}</span>
          </div>
          <div class="drug-name">{{ drug.name }}</div>
          @if (drug.manufacturer) {
            <div class="drug-manufacturer">üè≠ {{ drug.manufacturer }}</div>
          }
          @if (drug.activeIngredient) {
            <div class="drug-active-ingredient">üß¨ {{ drug.activeIngredient }}</div>
          }
          <div class="drug-description">{{ drug.description || ('drugIndex.modal.noDescription' | translate) }}</div>
          <div class="drug-info">
            <div class="info-item">
              <span class="info-label">{{ 'drugIndex.card.priceReference' | translate }}</span>
              <span class="info-value price">${{ drug.priceReference?.toFixed(2) || ('common.notAvailable' | translate) }}</span>
            </div>
          </div>
          @if (drug.barcode) {
            <div class="drug-barcodes">
              <span class="barcode-chip">{{ drug.barcode }}</span>
            </div>
          }
        </div>
      }
    </div>
  }
</div>

<!-- Drug Detail Modal -->
@if (selectedDrug) {
  <div class="modal active" (click)="closeModal()" id="drugModal">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-close" (click)="closeModal()">√ó</div>
      <div class="modal-header">
        <h2 class="modal-drug-name">{{ selectedDrug.name }}</h2>
        @if (selectedDrug.manufacturer) {
          <div class="modal-drug-manufacturer">üè≠ {{ selectedDrug.manufacturer }}</div>
        }
        <p class="modal-drug-description">{{ selectedDrug.description || ('drugIndex.modal.noDescription' | translate) }}</p>
      </div>

      <div class="modal-sections">
        <!-- Drug Information Section -->
        <div class="modal-section">
          <h3 class="modal-section-title">üíä {{ 'drugIndex.modal.drugInfo' | translate }}</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">{{ 'drugIndex.modal.type' | translate }}</span>
              <span class="detail-value">{{ selectedDrug.type || ('common.notAvailable' | translate) }}</span>
            </div>
            @if (selectedDrug.activeIngredient) {
              <div class="detail-item">
                <span class="detail-label">{{ 'drugIndex.modal.activeIngredient' | translate }}</span>
                <span class="detail-value">{{ selectedDrug.activeIngredient }}</span>
              </div>
            }
            <div class="detail-item">
              <span class="detail-label">{{ 'drugIndex.modal.priceReference' | translate }}</span>
              <span class="detail-value highlight">${{ selectedDrug.priceReference?.toFixed(2) || ('common.notAvailable' | translate) }}</span>
            </div>
            @if (selectedDrug.genericName) {
              <div class="detail-item">
                <span class="detail-label">{{ 'drugIndex.modal.genericName' | translate }}</span>
                <span class="detail-value">{{ selectedDrug.genericName }}</span>
              </div>
            }
            @if (selectedDrug.barcode) {
              <div class="detail-item">
                <span class="detail-label">{{ 'drugIndex.modal.barcode' | translate }}</span>
                <span class="detail-value">{{ selectedDrug.barcode }}</span>
              </div>
            }
            @if (selectedDrug.atcCode) {
              <div class="detail-item">
                <span class="detail-label">{{ 'drugIndex.modal.atcCode' | translate }}</span>
                <span class="detail-value">{{ selectedDrug.atcCode }}</span>
              </div>
            }
            @if (selectedDrug.therapeuticClass) {
              <div class="detail-item">
                <span class="detail-label">{{ 'drugIndex.modal.therapeuticClass' | translate }}</span>
                <span class="detail-value">{{ selectedDrug.therapeuticClass }}</span>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  </div>
}

